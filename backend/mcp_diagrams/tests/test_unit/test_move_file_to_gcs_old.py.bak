"""Unit tests for GCS file upload."""

import pytest
from unittest.mock import MagicMock, patch, call
from move_file_to_gcs import move_file_to_gcs


pytestmark = pytest.mark.unit


class TestMoveFileToGCS:
    """Tests for the move_file_to_gcs function."""

    def test_move_file_to_gcs_uploads_file(self, mock_gcs_client, tmp_path):
        """Test that move_file_to_gcs uploads a file to GCS."""
        # Arrange
        test_file = tmp_path / "test_diagram.png"
        test_file.write_text("fake image")
        filename = str(test_file)
        bucket_name = "test-bucket"
        project_id = "test-project"

        with patch("os.remove") as mock_remove:
            # Act
            result = move_file_to_gcs(filename, bucket_name, project_id)

            # Assert
            mock_gcs_client.bucket.assert_called_once_with(bucket_name)
            # Blob should be created and uploaded
            assert result is not None

    def test_move_file_to_gcs_creates_blob(self, mock_gcs_client):
        """Test that move_file_to_gcs creates a blob with correct name."""
        # Arrange
        filename = "my_diagram.png"
        bucket_name = "my-bucket"

        with patch("os.remove"):
            # Act
            result = move_file_to_gcs(filename, bucket_name, "test-project")

            # Assert
            bucket = mock_gcs_client.bucket.return_value
            bucket.blob.assert_called_once_with(filename)

    def test_move_file_to_gcs_uploads_from_filename(self, mock_gcs_client):
        """Test that move_file_to_gcs calls upload_from_filename."""
        # Arrange
        filename = "test.png"
        bucket_name = "test-bucket"

        with patch("os.remove"):
            # Act
            move_file_to_gcs(filename, bucket_name, "test-project")

            # Assert
            blob = mock_gcs_client.bucket.return_value.blob.return_value
            blob.upload_from_filename.assert_called_once_with(filename)

    def test_move_file_to_gcs_removes_local_file(self, mock_gcs_client):
        """Test that move_file_to_gcs removes the local file after upload."""
        # Arrange
        filename = "test.png"
        bucket_name = "test-bucket"

        with patch("os.remove") as mock_remove:
            # Act
            move_file_to_gcs(filename, bucket_name, "test-project")

            # Assert
            mock_remove.assert_called_once_with(filename)

    def test_move_file_to_gcs_returns_blob(self, mock_gcs_client):
        """Test that move_file_to_gcs returns the uploaded blob."""
        # Arrange
        filename = "test.png"
        bucket_name = "test-bucket"
        expected_blob = mock_gcs_client.bucket.return_value.blob.return_value

        with patch("os.remove"):
            # Act
            result = move_file_to_gcs(filename, bucket_name, "test-project")

            # Assert
            assert result == expected_blob

    def test_move_file_to_gcs_uses_provided_project_id(self):
        """Test that move_file_to_gcs uses the provided project ID."""
        # Arrange
        with patch("google.cloud.storage.Client") as mock_client_class, patch(
            "os.remove"
        ):
            mock_client = MagicMock()
            mock_client_class.return_value = mock_client

            mock_bucket = MagicMock()
            mock_blob = MagicMock()
            mock_bucket.blob.return_value = mock_blob
            mock_client.bucket.return_value = mock_bucket

            filename = "test.png"
            bucket_name = "test-bucket"
            project_id = "my-custom-project"

            # Act
            move_file_to_gcs(filename, bucket_name, project_id)

            # Assert
            mock_client_class.assert_called_once_with(project=project_id)

    def test_move_file_to_gcs_uses_env_var_when_no_project_id(self, monkeypatch):
        """Test that move_file_to_gcs uses environment variable when project_id is None."""
        # Arrange
        monkeypatch.setenv("GCP_PROJECT_ID", "env-project-id")

        with patch("google.cloud.storage.Client") as mock_client_class, patch(
            "os.remove"
        ):
            mock_client = MagicMock()
            mock_client_class.return_value = mock_client

            mock_bucket = MagicMock()
            mock_blob = MagicMock()
            mock_bucket.blob.return_value = mock_blob
            mock_client.bucket.return_value = mock_bucket

            filename = "test.png"
            bucket_name = "test-bucket"

            # Act
            move_file_to_gcs(filename, bucket_name, project_id=None)

            # Assert
            mock_client_class.assert_called_once_with(project="env-project-id")

    def test_move_file_to_gcs_with_different_filenames(self, mock_gcs_client):
        """Test move_file_to_gcs with various filename formats."""
        # Arrange
        filenames = [
            "simple.png",
            "with-dashes.png",
            "with_underscores.png",
            "uuid-7abc1234-5678.png",
        ]

        with patch("os.remove"):
            for filename in filenames:
                # Act
                result = move_file_to_gcs(filename, "test-bucket", "test-project")

                # Assert
                bucket = mock_gcs_client.bucket.return_value
                # Check that blob was created with the filename
                assert bucket.blob.called


class TestMoveFileToGCSErrorHandling:
    """Tests for error handling in move_file_to_gcs."""

    def test_move_file_to_gcs_handles_upload_failure(self):
        """Test that upload failures are propagated."""
        # Arrange
        with patch("google.cloud.storage.Client") as mock_client_class, patch(
            "os.remove"
        ):
            mock_client = MagicMock()
            mock_client_class.return_value = mock_client

            mock_bucket = MagicMock()
            mock_blob = MagicMock()
            mock_blob.upload_from_filename.side_effect = Exception("Upload failed")
            mock_bucket.blob.return_value = mock_blob
            mock_client.bucket.return_value = mock_bucket

            # Act & Assert
            with pytest.raises(Exception, match="Upload failed"):
                move_file_to_gcs("test.png", "test-bucket", "test-project")

    def test_move_file_to_gcs_file_removal_after_upload(self, mock_gcs_client):
        """Test that file is removed even if it doesn't exist locally (edge case)."""
        # Arrange
        filename = "nonexistent.png"

        with patch("os.remove") as mock_remove:
            # Act
            move_file_to_gcs(filename, "test-bucket", "test-project")

            # Assert
            mock_remove.assert_called_once_with(filename)


class TestMoveFileToGCSBlobProperties:
    """Tests for blob properties returned by move_file_to_gcs."""

    def test_returned_blob_has_bucket_name(self, mock_gcs_client):
        """Test that returned blob contains bucket name."""
        # Arrange
        bucket_name = "my-test-bucket"

        with patch("os.remove"):
            # Act
            result = move_file_to_gcs("test.png", bucket_name, "test-project")

            # Assert
            assert result.bucket.name == "test-bucket"

    def test_returned_blob_has_filename(self, mock_gcs_client):
        """Test that returned blob contains filename."""
        # Arrange
        filename = "my-diagram.png"

        with patch("os.remove"):
            # Act
            result = move_file_to_gcs(filename, "test-bucket", "test-project")

            # Assert
            assert result.name == "test-file.png"  # From mock


class TestMoveFileToGCSIntegration:
    """Integration-style tests (still mocked but more realistic flows)."""

    def test_complete_file_upload_flow(self):
        """Test the complete flow of uploading and removing a file."""
        # Arrange
        with patch("google.cloud.storage.Client") as mock_client_class, patch(
            "os.remove"
        ) as mock_remove:
            # Set up mocks
            mock_client = MagicMock()
            mock_bucket = MagicMock()
            mock_blob = MagicMock()
            mock_blob.bucket.name = "upload-bucket"
            mock_blob.name = "uploaded-file.png"

            mock_bucket.blob.return_value = mock_blob
            mock_client.bucket.return_value = mock_bucket
            mock_client_class.return_value = mock_client

            filename = "local-diagram.png"
            bucket_name = "upload-bucket"
            project_id = "my-project"

            # Act
            result = move_file_to_gcs(filename, bucket_name, project_id)

            # Assert - verify all steps executed
            mock_client_class.assert_called_once_with(project=project_id)
            mock_client.bucket.assert_called_once_with(bucket_name)
            mock_bucket.blob.assert_called_once_with(filename)
            mock_blob.upload_from_filename.assert_called_once_with(filename)
            mock_remove.assert_called_once_with(filename)

            assert result == mock_blob
